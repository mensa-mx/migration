#!/usr/bin/env php
<?php
/**
 * @author Alberto Maturano <alberto@maturano.mx>
 */

require 'cli-config.php';

use Mensa\Member;
use Mensa\Membership;

// Datos de conexión como parámetros del script
$dbParams = [
    'host'     => 'localhost',
    'database' => $argv[1],
    'username' => $argv[2],
    'password' => $argv[3],
];


$sqlMembers = <<<SQL
SELECT
    member_id,
    user_first_name,
    user_last_name,
    -- El campo está pero ningún registro tienen información válida
    'MASCULINO' AS user_gender,
    -- Normalizando fechas '0000-00-00' a NULL
    DATE (NULLIF (user_birthdate, '0000-00-00')) AS user_birthdate,
    user_email1,
    user_admission,
    -- Si fecha de creación es inválida se recupera la de última modificación
    TIMESTAMP (COALESCE (
      NULLIF (user_timestamp_created, '0000-00-00'),
      NULLIF (user_timestamp_updated, '0000-00-00')
    )) AS user_timestamp_created

FROM
    users

WHERE
    user_admission IS NOT NULL

ORDER BY member_id
SQL;

$sqlMemberships = <<<SQL
SELECT
    member_id,
    membership_start,
    membership_end,
    membership_card_status,
    -- Si fecha de creación es inválida se recupera la de última modificación
    TIMESTAMP (COALESCE (
        NULLIF (membership_timestamp_created, '0000-00-00'),
        NULLIF (membership_timestamp_updated, '0000-00-00')
    )) AS membership_timestamp_created

FROM
    memberships

WHERE
    COALESCE (
        NULLIF (membership_start, '0000-00-00'),
        NULLIF (membership_end,   '0000-00-00')
    ) IS NOT NULL

ORDER BY member_id
SQL;


try {
    $conn = new \PDO(
        "mysql:dbname={$dbParams['database']};host={$dbParams['host']}",
        $dbParams['username'],
        $dbParams['password']
    );

    // Permite ignorar la secuencia y asignar un ID manualmente
    $meta = $em->getClassMetaData('Mensa\Member');
    $meta->setIdGenerator(new \Doctrine\ORM\Id\AssignedGenerator());

} catch (\PDOException $e) {
    // TODO
    echo 'Connection Failed: ' . $e->getMessage() . PHP_EOL;
    exit(1);
}


$sth = $conn->prepare($sqlMembers);
$sth->execute();
$results = $sth->fetchAll(\PDO::FETCH_ASSOC);

echo 'Miembros a importar: ' . count($results) . PHP_EOL;

foreach ($results as $row) {

    $member = (new Member())
        ->setId($row['member_id'])
        ->setFirstName($row['user_first_name'])
        ->setLastName($row['user_last_name'])
        ->setGender($row['user_gender'])
        ->setBirthdate($row['user_birthdate'])
        ->setEmail($row['user_email1'])
        ->setAdmissionType($row['user_admission'])
        ->setCreated($row['user_timestamp_created'])
    ;

    $em->persist($member);
}


$sth = $conn->prepare($sqlMemberships);
$sth->execute();
$results = $sth->fetchAll(\PDO::FETCH_ASSOC);

echo 'Membresías a importar: ' . count($results) . PHP_EOL;

foreach ($results as $row) {

    $membership = (new Membership())
        ->setMember($em->find('Mensa\Member', $row['member_id']))
        ->setStart($row['membership_start'])
        ->setEnd($row['membership_end'])
        ->setDelivery($row['membership_card_status'])
        ->setCreated($row['membership_timestamp_created'])
    ;

    $em->persist($membership);
}

$em->flush();

// vim: ft=php :
