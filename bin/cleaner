#!/usr/bin/env php
<?php
/**
 * @author Alberto Maturano <alberto@maturano.mx>
 */

require 'cli-config.php';

use Mensa\Migration;
use Mensa\Clean;
use Mensa\Util\Cleaner;


$em->getClassMetaData('Mensa\Clean\Member')->setIdGenerator(new \Doctrine\ORM\Id\AssignedGenerator());


$migMembers = $em->getRepository('\Mensa\Migration\Member')->findAll();

echo 'Por procesar: ' . count($migMembers) . PHP_EOL;

foreach ($migMembers as $migMember) {

    //-- Member --//
    echo "\t" . $migMember->getId();
    $member = (new Clean\Member())
        /** @var Migration\Member $migMember */
        ->setId($migMember->getId())
        ->setFirstName($migMember->getFirstName())
        ->setLastName($migMember->getLastName())
        ->setGender($migMember->getGender())
        ->setBirthdate(Cleaner::date($migMember->getBirthdate()))
        ->setEmail($migMember->getEmail())
        ->setCreated(Cleaner::date($migMember->getCreated()))
        ->setAdmissionType($migMember->getAdmissionType())
    ;


    //-- Address --//
    $migAddress = $migMember->getAddress();
    echo "\t" . $migAddress->getId();

    $address = (new Clean\Address())
        /** @var Migration\Address $migAddress */
        ->setAddressLine1($migAddress->getAddressLine1())
        ->setAddressLine2($migAddress->getAddressLine2())
        ->setCity($migAddress->getCity())
        ->setColony($migAddress->getColony())
        ->setState($migAddress->getState())
        ->setPostalCode($migAddress->getPostalCode())
        ->setMember($member)
    ;

    $member->setAddress($address);
    $em->persist($address);
    $em->persist($member);


    //-- Memberships --//
    $memberships = $migMember->getMemberships();
    echo "\t" . count($memberships);

    foreach ($memberships as $migMembership) {
        echo "\t" . $migMembership->getId();

        $membership = (new Clean\Membership())
            /** @var Migration\Membership $migMembership */
            ->setStart(Cleaner::date($migMembership->getStart()))
            ->setEnd(Cleaner::date($migMembership->getEnd()))
            ->setDelivery($migMembership->getDelivery())
            ->setCreated(\DateTime::createFromFormat('Y-m-d H:i:s', $migMembership->getCreated()))
            ->setMember($member)
        ;

        $em->persist($membership);
    }

    echo PHP_EOL;
}

$em->flush();
