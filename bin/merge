#!/usr/bin/env php
<?php
/**
 * @author Alberto Maturano <alberto@maturano.mx>
 */

require 'cli-config.php';

use Mensa\Member;
use Mensa\Membership;
use Mensa\Address;


$results = array_map('str_getcsv', file($params['provisional_file']));

echo 'Registros a fusionar: ' . (count($results) - 1) . PHP_EOL;

$line = $regNew = $regUps = 0;
foreach ($results as $row) {
    $line++;
    if ($line === 1) { continue; } // Header...

    if (empty($row[2])) {
        echo '[ERROR] Falta ID para fila: ' . $line . PHP_EOL;
        continue;
    }

    $member = $em->find('Mensa\Member', $row[2]);

    if ($member) {
        $isNew = false;
        $regUps++;

    } else if ( ! empty($row[6])) {
        $isNew = true;
        $regNew++;

        $member = (new Member())
            ->setId($row[2])
            ->setCreated(date('Y-m-d'))
        ;

    } else {
        echo '[ERROR] Falta TIPO ADMISION para fila: ' . $line . PHP_EOL;
        continue;
    }

    $member->setFromArray([
        'firstName'     => $row[3],
        'lastName'      => $row[4],
        'gender'        => $row[18],
        'birthdate'     => $row[9],
        'email'         => $row[8],
        'admissionType' => $row[6],
    ]);

    if ($isNew) {
        $address = (new Address())->setMember($member);

        $member->setAddress($address);

    } else {
        $address = $member->getAddress();
    }

    if (empty($row[12])) {
        // Pone órden a los datos de calle
        $row[12] = trim($row[11]);
        $row[11] = null;
    }

    // Limpia de cosas raras el dato de código postal
    $row[16] = str_replace([' ', '"', 'C.P.'], '', $row[16]);

    $address->setFromArray([
        'addressLine1'  => $row[12],
        'addressLine2'  => $row[11],
        'colony'        => $row[13],
        'city'          => $row[14],
        'state'         => $row[15],
        'postalCode'    => $row[16],
    ]);

    $em->persist($member);
    $em->persist($address);
}

try {
    $em->flush();

} catch (\PDOException $e) {
    echo '[ERROR] ' . $e->getMessage() . PHP_EOL;
    exit(1);
}

echo 'Registros nuevos: ' . $regNew . PHP_EOL . 'Registros modificados: ' . $regUps . PHP_EOL;
